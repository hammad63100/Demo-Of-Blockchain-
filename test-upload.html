<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain File Upload System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Add these script imports before your main script -->
    <script src="./config/qryptum.config.js"></script>
    <script src="./contracts/QryptToken.abi.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #818cf8;
            --success-color: #22c55e;
            --error-color: #ef4444;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1e293b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 0;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .auth-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        button {
            background: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        button:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .file-upload {
            border: 2px dashed #e2e8f0;
            padding: 2rem;
            text-align: center;
            border-radius: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: var(--primary-color);
            background: #f8fafc;
        }

        .file-upload i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .success {
            color: #ffffff;
            background: var(--success-color);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .error {
            color: #860707;
            background: var (--error-color);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .blockchain-data {
            background: #1e293b;
            color: #f8fafc;
            padding: 1.5rem;
            border-radius: 0.5rem;
            font-family: monospace;
            white-space: pre-wrap;
            margin-top: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading {
            animation: spin 1s linear infinite;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .file-details {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }

        .file-details h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .details-content {
            font-size: 0.9rem;
        }

        .details-content p {
            margin: 0.5rem 0;
        }

        .details-content a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .details-content a:hover {
            text-decoration: underline;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .status-item {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
            border: 1px solid #e2e8f0;
            transition: transform 0.3s ease;
        }

        .status-item:hover {
            transform: translateY(-5px);
        }

        .status-item i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .status-item h3 {
            color: var (--text-color);
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .status-item p {
            color: var(--primary-color);
            font-weight: bold;
        }

        .status-item p.disconnected {
            color: var(--error-color);
        }

        .status-item p.connected {
            color: var(--success-color);
        }

        .logout-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--error-color);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        /* Add new styles for peer functionality */
        .peer-list {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--card-bg);
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .peer-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .peer-item:last-child {
            border-bottom: none;
        }

        .notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--primary-color);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        @keyframes celebrateUp {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .balloon {
            position: fixed;
            font-size: 2rem;
            animation: celebrateUp 3s ease-out forwards;
        }

        .celebration h2 {
            color: var(--success-color);
            margin-bottom: 1rem;
        }

        .reward-text {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-top: 1rem;
        }

        @keyframes floatUp {
            0% {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -200%);
                opacity: 0;
            }
        }

        .celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-out;
        }

        .reward-number {
            z-index: 1001;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .balloon {
            position: fixed;
            animation: celebrateUp 3s ease-out forwards;
            z-index: 999;
        }

        @keyframes celebrateUp {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(-120vh) rotate(360deg);
                opacity: 0;
            }
        }

        .file-info, .blockchain-info, .transaction-info {
            background: #f8fafc;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }

        .file-info h4, .blockchain-info h4, .transaction-info h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Add new styles for blockchain display */
        .view-btn {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            text-decoration: none;
            margin-top: 1rem;
            transition: all 0.3s ease;
        }

        .view-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .blockchain-info {
            border-left: 4px solid var(--primary-color);
            margin-bottom: 1rem;
        }

        .transaction-info {
            border-left: 4px solid var(--success-color);
        }

        .file-info {
            border-left: 4px solid var(--secondary-color);
        }

        .error-details {
            font-size: 0.9em;
            margin-top: 0.5em;
            color: #fee2e2;
        }

        .info {
            background: var(--primary-color);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .error div {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        <header class="header">
            <h1><i class="fas fa-link"></i> Qryptum Blockchain</h1>
            <p>Secure decentralized file storage powered by Qryptum</p>
            <div id="welcomeMessage" style="margin-top: 10px; font-size: 1.2rem; display: none;">
                Welcome, <span id="userNameDisplay"></span>!
            </div>
        </header>

        <!-- Authentication Section -->
        <div class="card" id="authSection">
            <h2><i class="fas fa-user-shield"></i> Authentication</h2>
            <div class="auth-container">
                <div id="loginContainer">
                    <h3>Login</h3>
                    <form id="loginForm">
                        <div class="form-group">
                            <input type="text" id="loginUsername" placeholder="Username" required>
                        </div>
                        <div class="form-group">
                            <input type="password" id="loginPassword" placeholder="Password" required>
                        </div>
                        <button type="submit">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    </form>
                    <p>Don't have an account? <a href="#" id="showRegister">Register here</a></p>
                </div>
                <div id="registerContainer" style="display: none;">
                    <h3>Register</h3>
                    <form id="registerForm">
                        <div class="form-group">
                            <input type="text" id="regUsername" placeholder="Username" required>
                        </div>
                        <div class="form-group">
                            <input type="password" id="regPassword" placeholder="Password" required>
                        </div>
                        <button type="submit">
                            <i class="fas fa-user-plus"></i> Register
                        </button>
                    </form>
                    <p>Already have an account? <a href="#" id="showLogin">Login here</a></p>
                </div>
            </div>
            <div id="authStatus"></div>
        </div>

        <!-- Status Section -->
        <div class="card" id="statusSection" style="display: none;">
            <h2><i class="fas fa-chart-line"></i> System Status</h2>
            <div id="statusContainer">
                <div class="status-grid">
                    <div class="status-item">
                        <i class="fas fa-server"></i>
                        <h3>Pinata Connection</h3>
                        <p id="pinataStatus">Checking...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="card" id="uploadSection" style="display: none;">
            <h2><i class="fas fa-cloud-upload-alt"></i> File Upload</h2>
            <form id="uploadForm">
                <div class="file-upload">
                    <i class="fas fa-file-upload"></i>
                    <p>Drag and drop your file here or click to browse</p>
                    <input type="file" id="fileInput" name="file" required style="display: none">
                </div>
                <div class="form-group">
                    <input type="text" id="ethAddress" placeholder="Your Ethereum Address" required>
                </div>
                <button type="submit" style="margin-top: 1rem;">
                    <i class="fas fa-upload"></i> Upload File
                </button>
            </form>
            <div id="uploadStatus"></div>
            <div id="fileDetails" class="file-details" style="display:none;">
                <h3>File Details</h3>
                <div class="details-content">
                    <div class="file-info">
                        <h4><i class="fas fa-file"></i> File Information</h4>
                        <p><strong>File Name:</strong> <span id="fileName"></span></p>
                        <p><strong>File Type:</strong> <span id="fileType"></span></p>
                        <p><strong>File Size:</strong> <span id="fileSize"></span></p>
                        <p><strong>Upload Time:</strong> <span id="uploadTime"></span></p>
                        <p><strong>Uploaded By:</strong> <span id="uploadedBy"></span></p>
                    </div>
                    
                    <div class="blockchain-info">
                        <h4><i class="fas fa-link"></i> Blockchain Information</h4>
                        <p><strong>IPFS Hash:</strong> <span id="ipfsHash"></span></p>
                        <p><strong>Pinata URL:</strong> <a id="pinataUrl" target="_blank">View on IPFS</a></p>
                        <p><strong>Block Hash:</strong> <span id="blockHash"></span></p>
                        <p><strong>Previous Block:</strong> <span id="previousHash"></span></p>
                    </div>
                    
                    <div class="transaction-info">
                        <h4><i class="fas fa-exchange-alt"></i> Transaction Details</h4>
                        <p><strong>Transaction Hash:</strong> <a id="txHash" target="_blank"></a></p>
                        <p><strong>From Address:</strong> <span id="txFrom"></span></p>
                        <p><strong>To Address:</strong> <span id="txTo"></span></p>
                        <p><strong>Value:</strong> <span id="txValue"></span></p>
                        <p><strong>Gas Price:</strong> <span id="txGasPrice"></span></p>
                        <p><strong>Status:</strong> <span id="txStatus"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add a section to display blockchain data -->
        <div class="card" id="blockchainSection" style="display: none;">
            <h2><i class="fas fa-cube"></i> Blockchain History</h2>
            <div id="blockchainContainer"></div>
        </div>

        

    </div>

    <script>
        // Update API URL and add RECEIVER_ADDRESS constant
        const API_URL = 'http://localhost:3001/api';
        const RECEIVER_ADDRESS = '0x46299ac2A9DBaf393DC7B00A53A4B6894cB78F3E';

        // Remove dynamic hostname check since we know the backend port
        
        // Add error handler function
        const handleApiError = async (response) => {
            if (!response.ok) {
                const contentType = response.headers.get('content-type');
                let errorMessage;
                try {
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorData.error || 'Unknown error occurred';
                    } else {
                        errorMessage = await response.text();
                    }
                } catch (e) {
                    errorMessage = response.statusText || 'Network error occurred';
                }
                throw new Error(errorMessage);
            }
            return response;
        };

        // Add a new global error handler function
        const handleError = (error, context = '') => {
            console.error(`Error ${context}:`, error);
            const errorMessage = error.message || 'An unexpected error occurred';
            showNotification(errorMessage, 'error');
        };

        // Toggle between login and register forms
        document.getElementById('showRegister').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('registerContainer').style.display = 'block';
        });

        document.getElementById('showLogin').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('registerContainer').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'block';
        });

        // Check login state on page load
        window.addEventListener('load', () => {
            if (localStorage.getItem('loggedIn') === 'true') {
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('statusSection').style.display = 'block';
                document.getElementById('uploadSection').style.display = 'block';
                document.getElementById('welcomeMessage').style.display = 'block';
                document.getElementById('userNameDisplay').textContent = localStorage.getItem('username');
                updateSystemStatus();
                fetchBlockchainData();
            }
        });

        // File upload preview
        const fileUpload = document.querySelector('.file-upload');
        const fileInput = document.getElementById('fileInput');

        fileUpload.addEventListener('click', () => fileInput.click());
        fileUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUpload.style.borderColor = 'var(--primary-color)';
            fileUpload.style.background = '#f8fafc';
        });

        fileUpload.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileUpload.style.borderColor = '#e2e8f0';
            fileUpload.style.background = 'transparent';
        });

        fileUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            fileInput.files = e.dataTransfer.files;
            fileUpload.style.borderColor = '#e2e8f0';
            fileUpload.style.background = 'transparent';
            if (e.dataTransfer.files.length > 0) {
                fileUpload.querySelector('p').textContent = `Selected file: ${e.dataTransfer.files[0].name}`;
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const fileSizeInKB = file.size / 1024;
                const baseCharge = Math.floor(fileSizeInKB * 0.8 * 1e18); // Same calculation as above
                const uploadChargeEth = web3.utils.fromWei(baseCharge.toString(), 'ether');
                const estimatedRewardEth = (parseFloat(uploadChargeEth) * 1.5).toFixed(18); // 50% more as reward
                
                fileUpload.querySelector('p').textContent = 
                    `Selected file: ${file.name} (${(fileSizeInKB / 1024).toFixed(2)} MB)
                    Upload charge: ${uploadChargeEth} ETH
                    Estimated reward: ${estimatedRewardEth} ETH`;
            }
        });

        // Register functionality
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const authStatus = document.getElementById('authStatus');
            try {
                const response = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: document.getElementById('regUsername').value,
                        password: document.getElementById('regPassword').value
                    })
                });
                const data = await response.json();
                authStatus.innerHTML = `
                    <div class="success fade-in">
                        <i class="fas fa-check-circle"></i>
                        <span>${data.message}</span>
                    </div>
                `;
                document.getElementById('regUsername').value = '';
                document.getElementById('regPassword').value = '';
            } catch (error) {
                authStatus.innerHTML = `
                    <div class="error fade-in">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>Registration failed: ${error.message}</span>
                    </div>
                `;
            }
        });

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const authStatus = document.getElementById('authStatus');
            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: document.getElementById('loginUsername').value,
                        password: document.getElementById('loginPassword').value
                    })
                });
                
                await handleApiError(response);
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Login successful!', 'success');
                    authStatus.innerHTML = `
                        <div class="success fade-in">
                            <i class="fas fa-check-circle"></i>
                            <span>${data.message}</span>
                        </div>
                    `;
                    localStorage.setItem('loggedIn', 'true');
                    localStorage.setItem('username', document.getElementById('loginUsername').value);
                    document.getElementById('authSection').style.display = 'none';
                    document.getElementById('statusSection').style.display = 'block';
                    document.getElementById('uploadSection').style.display = 'block';
                    document.getElementById('welcomeMessage').style.display = 'block';
                    document.getElementById('userNameDisplay').textContent = localStorage.getItem('username');
                    updateSystemStatus();
                    fetchBlockchainData();
                    
                    // Connect WebSocket after successful login
                    connectWebSocket();
                } else {
                    authStatus.innerHTML = `
                        <div class="error fade-in">
                            <i class="fas fa-exclamation-circle"></i>
                            <span>Login failed: ${data.message}</span>
                        </div>
                    `;
                }
            } catch (error) {
                handleError(error, 'during login');
                document.getElementById('loginPassword').value = ''; // Clear password on error
                authStatus.innerHTML = `
                    <div class="error fade-in">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>Login failed: ${error.message}</span>
                    </div>
                `;
            }
        });

        // Add network configuration
        const SEPOLIA_CHAIN_ID = '0xaa36a7'; // Chain ID for Sepolia
        
        // Function to ensure correct network
        async function ensureSepoliaNetwork() {
            try {
                await ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: SEPOLIA_CHAIN_ID }],
                });
            } catch (error) {
                if (error.code === 4902) {
                    await ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: SEPOLIA_CHAIN_ID,
                            chainName: 'Sepolia Test Network',
                            nativeCurrency: {
                                name: 'SepoliaETH',
                                symbol: 'ETH',
                                decimals: 18
                            },
                            rpcUrls: ['https://sepolia.infura.io/v3/'],
                            blockExplorerUrls: ['https://sepolia.etherscan.io']
                        }]
                    });
                }
            }
        }

        // Add in the script section
        const QRYPTUM_NETWORK = {
            chainId: '0x7A69',
            chainName: 'Qryptum Network',
            nativeCurrency: {
                name: 'QRYPT',
                symbol: 'QRYPT',
                decimals: 18
            },
            rpcUrls: ['http://127.0.0.1:8545'],
            blockExplorerUrls: ['http://localhost:8545']
        };

        async function addQryptumNetwork() {
            try {
                await ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: '0x539', // Hex of 1337
                        chainName: 'Qryptum Network',
                        nativeCurrency: {
                            name: 'Ether',
                            symbol: 'ETH', // Changed from QRYPT to ETH
                            decimals: 18
                        },
                        rpcUrls: ['http://127.0.0.1:8545'],
                        blockExplorerUrls: ['http://localhost:8545']
                    }]
                });
                console.log('Qryptum network added successfully');
            } catch (error) {
                console.error('Failed to add Qryptum network:', error);
                throw error;
            }
        }

        // Update the upload form handler to include token approval
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                // Ensure connected to Qryptum network
                if (ethereum.chainId !== QRYPTUM_NETWORK.chainId) {
                    await addQryptumNetwork();
                }

                const file = fileInput.files[0];
                const fileSizeInKB = file.size / 1024;
                const uploadCharge = (0.03 * (fileSizeInKB / 100)).toFixed(6);

                // Approve QRYPT token spending
                const tokenContract = new web3.eth.Contract(QryptTokenABI, QRYPTUM_CONFIG.TOKEN_ADDRESS);
                await tokenContract.methods.approve(QRYPTUM_CONFIG.MAIN_ACCOUNT.ADDRESS, uploadCharge)
                    .send({ from: ethereum.selectedAddress });

                // Continue with file upload
                // ...existing upload code...
            } catch (error) {
                handleError(error);
            }
        });

        // Update the file upload event listener
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = localStorage.getItem('username');
            if (!username) {
                showNotification('Please login first', 'error');
                return;
            }

            const fileInput = document.getElementById('fileInput');
            const ethAddress = document.getElementById('ethAddress').value;
            const uploadStatus = document.getElementById('uploadStatus');

            if (!fileInput.files[0]) {
                showNotification('Please select a file', 'error');
                return;
            }

            if (!ethAddress) {
                showNotification('Please enter your ETH address', 'error');
                return;
            }

            try {
                // Show loading state
                uploadStatus.innerHTML = `
                    <div class="info fade-in">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Checking file uniqueness...</span>
                    </div>
                `;

                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('ethAddress', ethAddress);

                const response = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    headers: {
                        'X-User-Name': username
                    },
                    body: formData
                });

                const result = await response.json();

                if (!response.ok) {
                    // Show error details including API response
                    uploadStatus.innerHTML = `
                        <div class="error fade-in">
                            <i class="fas fa-exclamation-circle"></i>
                            <div>
                                <p>${result.message}</p>
                                ${result.score !== undefined ? `
                                    <p>Uniqueness Score: ${result.score}</p>
                                    <p class="error-details">Your file needs a uniqueness score of at least 50 to be uploaded.</p>
                                ` : ''}
                                ${result.error ? `
                                    <p class="error-details">Error Details: ${result.error}</p>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    return;
                }

                // Success handling
                if (result.success) {
                    // Ensure we're on Sepolia network
                    await ensureSepoliaNetwork();
                    
                    const fileInput = document.getElementById('fileInput');
                    const ethAddress = document.getElementById('ethAddress').value;

                    if (!fileInput.files[0]) {
                        showNotification('Please select a file', 'error');
                        return;
                    }

                    if (!ethAddress) {
                        showNotification('Please enter your ETH address', 'error');
                        return;
                    }

                    // Calculate payment amount
                    const fileSizeInKB = fileInput.files[0].size / 1024;
                    const ethAmount = (1 * (fileSizeInKB / 100)).toFixed(6);

                    showNotification('Please confirm the transaction in MetaMask...', 'info');

                    try {
                        // Request account access
                        await requestAccount();
                        const accounts = await ethereum.request({ method: 'eth_accounts' });
                        if (accounts.length === 0) {
                            throw new Error('Please connect to MetaMask');
                        }

                        const senderAccount = accounts[0];
                        const web3 = new Web3(window.ethereum);
                        const nonce = await web3.eth.getTransactionCount(senderAccount, 'latest');
                        const gasPrice = await web3.eth.getGasPrice();
                        const adjustedGasPrice = Math.floor(Number(gasPrice) * 1.1).toString();

                        // Prepare transaction
                        const transactionParameters = {
                            nonce: web3.utils.toHex(nonce),
                            to: RECEIVER_ADDRESS,
                            from: senderAccount,
                            value: web3.utils.toHex(web3.utils.toWei(ethAmount, 'ether')),
                            gas: web3.utils.toHex(21000),
                            gasPrice: web3.utils.toHex(adjustedGasPrice),
                            chainId: parseInt(SEPOLIA_CHAIN_ID, 16)
                        };

                        // Send transaction and wait for confirmation
                        const txHash = await ethereum.request({
                            method: 'eth_sendTransaction',
                            params: [transactionParameters],
                        });

                        showNotification('Transaction sent, waiting for confirmation...', 'info');

                        // Wait for transaction confirmation
                        const receipt = await waitForTransaction(web3, txHash);
                        
                        if (!receipt.status) {
                            throw new Error('Transaction failed');
                        }

                        showNotification('Payment confirmed! Uploading file...', 'success');

                        // Now proceed with file upload
                        const formData = new FormData();
                        formData.append('file', fileInput.files[0]);
                        formData.append('ethAddress', ethAddress);
                        formData.append('transactionHash', txHash);

                        const uploadResponse = await fetch(`${API_URL}/upload`, {
                            method: 'POST',
                            headers: {
                                'X-User-Name': username
                            },
                            body: formData
                        });

                        if (!uploadResponse.ok) {
                            const errorData = await uploadResponse.json();
                            throw new Error(errorData.message || 'Upload failed');
                        }

                        const uploadResult = await uploadResponse.json();
                        
                        if (uploadResult.success) {
                            // Show upload success and celebration
                            showNotification('File uploaded successfully!', 'success');
                            showCelebration(ethAmount, receipt.transactionHash);
                            
                            // Update file details display
                            updateFileDetails(uploadResult.data);
                            
                            // Clear form and refresh data
                            fileInput.value = '';
                            fileUpload.querySelector('p').textContent = 'Drag and drop your file here or click to browse';
                            fetchBlockchainData();
                        }
                    } catch (error) {
                        console.error('Transaction error:', error);
                        showNotification(error.message, 'error');
                        throw error;
                    }

                    handleError(error, 'during file upload');
                    console.error('Upload error:', error);
                    showNotification('Upload failed: ' + (error.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                uploadStatus.innerHTML = `
                    <div class="error fade-in">
                        <i class="fas fa-exclamation-circle"></i>
                        <div>
                            <p>Upload failed: ${error.message}</p>
                            <p class="error-details">Please try again or contact support if the issue persists.</p>
                        </div>
                    </div>
                `;
            }
        });

        // Add function to wait for transaction confirmation
        async function waitForTransaction(web3, txHash) {
            const maxAttempts = 50; // Maximum attempts to check transaction
            const interval = 1000; // Check every second

            for (let i = 0; i < maxAttempts; i++) {
                const receipt = await web3.eth.getTransactionReceipt(txHash);
                if (receipt) {
                    return receipt;
                }
                await new Promise(resolve => setTimeout(resolve, interval));
            }
            throw new Error('Transaction confirmation timeout');
        }

        // Update celebration function to include transaction details
        function showCelebration(rewardAmount, uploadCharge, txHash) {
            const celebration = document.createElement('div');
            celebration.className = 'celebration fade-in';
            celebration.innerHTML = `
                <h2><i class="fas fa-check-circle"></i> Success!</h2>
                <p>File uploaded successfully</p>
                <p class="reward-text">
                    🔸 Upload charge: ${uploadCharge} ETH<br>
                    🎉 You earned ${rewardAmount} ETH! 🎉<br>
                    Net reward: ${(rewardAmount - uploadCharge).toFixed(6)} ETH
                </p>
                <p class="transaction-text">
                    <a href="https://sepolia.etherscan.io/tx/${txHash}" target="_blank">
                        View Transaction <i class="fas fa-external-link-alt"></i>
                    </a>
                </p>
            `;
            // ...rest of the celebration function remains the same...
        }

        // Add file size formatter
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showNotification(message, type = 'info') {
            const status = document.getElementById('uploadStatus');
            const icon = type === 'success' ? 'check-circle' : 
                         type === 'error' ? 'exclamation-circle' : 
                         type === 'info' ? 'info-circle' : 'bell';
            
            const notification = `
                <div class="${type} fade-in">
                    <i class="fas fa-${icon}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            status.innerHTML = notification;
            
            // Auto-hide non-error notifications after 5 seconds
            if (type !== 'error') {
                setTimeout(() => {
                    status.innerHTML = '';
                }, 5000);
            }
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await fetch(`${API_URL}/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (ws) {
                    ws.send(JSON.stringify({
                        type: 'disconnect',
                        username: localStorage.getItem('username')
                    }));
                }
                
                localStorage.setItem('loggedIn', 'false');
                localStorage.removeItem('username');
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('statusSection').style.display = 'none';
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('welcomeMessage').style.display = 'none';
                document.getElementById('userNameDisplay').textContent = '';
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Check if MetaMask is installed
        if (typeof window.ethereum !== 'undefined') {
            console.log('MetaMask is installed!');
        } else {
            alert('Please install MetaMask to use this feature.');
        }

        // Request account access if needed
        async function requestAccount() {
            await window.ethereum.request({ method: 'eth_requestAccounts' });
        }

        // Add WebSocket connection
        let ws;
        const connectWebSocket = () => {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log('WebSocket connected');
                    showNotification('Connected to real-time updates', 'success');
                    if (localStorage.getItem('loggedIn') === 'true') {
                        ws.send(JSON.stringify({
                            type: 'register',
                            username: localStorage.getItem('username')
                        }));
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    showNotification('Real-time connection failed', 'error');
                };

                ws.onclose = () => {
                    console.log('WebSocket disconnected. Reconnecting...');
                    showNotification('Connection lost. Reconnecting...', 'info');
                    setTimeout(connectWebSocket, 3000);
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    switch(data.type) {
                        case 'peerList':
                            updatePeerList(data.peers);
                            break;
                        case 'newFile':
                            handleNewFileNotification(data);
                            break;
                    }
                };

            } catch (error) {
                handleError(error, 'WebSocket connection');
            }
        };

        // Add peer list update function
        function updatePeerList(peers) {
            const peersList = document.getElementById('peersList');
            peersList.innerHTML = '';
            peers.forEach(peer => {
                const peerElement = document.createElement('div');
                peerElement.className = 'peer-item';
                peerElement.innerHTML = `
                    <i class="fas fa-user"></i>
                    <span>${peer}</span>
                    ${peer === localStorage.getItem('username') ? ' (You)' : ''}
                `;
                peersList.appendChild(peerElement);
            });
        }

        // Add new file notification handler
        function handleNewFileNotification(data) {
            const notification = document.createElement('div');
            notification.className = 'notification fade-in';
            notification.innerHTML = `
                <i class="fas fa-file-upload"></i>
                <span>${data.uploader} uploaded a new file: ${data.file.fileName}</span>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        // Update the celebration function to make it more visible
        function showCelebration(rewardAmount) {
            const celebration = document.createElement('div');
            celebration.className = 'celebration fade-in';
            celebration.innerHTML = `
                <h2><i class="fas fa-check-circle"></i> Success!</h2>
                <p>File uploaded successfully</p>
                <p class="reward-text">🎉 You earned ${rewardAmount} ETH! 🎉</p>
            `;
            document.body.appendChild(celebration);

            // Create more balloons for better effect
            const colors = ['🎈', '🎉', '🎊', '⭐', '🌟', '💰', '🪙'];
            for (let i = 0; i < 30; i++) { // Increased from 20 to 30 balloons
                const balloon = document.createElement('div');
                balloon.className = 'balloon';
                balloon.textContent = colors[Math.floor(Math.random() * colors.length)];
                balloon.style.left = Math.random() * 100 + 'vw';
                balloon.style.top = (Math.random() * 50 + 50) + 'vh';
                document.body.appendChild(balloon);
                
                // Remove balloon after animation
                balloon.addEventListener('animationend', () => balloon.remove());
            }

            // Show celebration for longer (7 seconds instead of 3)
            setTimeout(() => {
                celebration.classList.remove('fade-in');
                celebration.classList.add('fade-out');
                setTimeout(() => celebration.remove(), 500);
            }, 13000);
        }

        // Function to fetch and display blockchain data
        async function fetchBlockchainData() {
            try {
                const response = await fetch(`${API_URL}/blockchain`);
                await handleApiError(response);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to fetch blockchain data');
                }

                const blockchainContainer = document.getElementById('blockchainContainer');
                blockchainContainer.innerHTML = '';
                
                // Skip genesis block by starting from index 1
                data.data.chain.slice(1).forEach(block => {
                    const blockElement = document.createElement('div');
                    blockElement.className = 'file-details';
                    
                    if (block.data.fileInfo) {
                        blockElement.innerHTML = `
                            <div class="blockchain-info">
                                <h4><i class="fas fa-cube"></i> Block Information</h4>
                                <p><strong>Block Hash:</strong> ${block.hash}</p>
                                <p><strong>Previous Hash:</strong> ${block.previousHash}</p>
                                <p><strong>Timestamp:</strong> ${new Date(block.timestamp).toLocaleString()}</p>
                                <p><strong>Nonce:</strong> ${block.nonce}</p>
                            </div>
                            
                            <div class="file-info">
                                <h4><i class="fas fa-file"></i> File Information</h4>
                                <p><strong>File Name:</strong> ${block.data.fileInfo.fileName}</p>
                                <p><strong>File Type:</strong> ${block.data.fileInfo.fileType}</p>
                                <p><strong>File Size:</strong> ${formatFileSize(block.data.fileInfo.fileSize)}</p>
                                <p><strong>IPFS Hash:</strong> ${block.data.fileInfo.ipfsHash}</p>
                                <a href="${block.data.fileInfo.pinataUrl}" target="_blank" class="view-btn">
                                    <i class="fas fa-external-link-alt"></i> View File
                                </a>
                            </div>

                            ${block.data.uploadInfo ? `
                                <div class="transaction-info">
                                    <h4><i class="fas fa-exchange-alt"></i> Transaction Details</h4>
                                    <p><strong>Uploaded By:</strong> ${block.data.uploadInfo.uploadedBy}</p>
                                    <p><strong>Upload Time:</strong> ${new Date(block.data.uploadInfo.uploadTime).toLocaleString()}</p>
                                    ${block.data.uploadInfo.transaction ? `
                                        <p><strong>Transaction Hash:</strong> 
                                            <a href="https://sepolia.etherscan.io/tx/${block.data.uploadInfo.transaction.hash}" target="_blank">
                                                ${block.data.uploadInfo.transaction.hash}
                                            </a>
                                        </p>
                                        <p><strong>Value:</strong> ${block.data.uploadInfo.transaction.value}</p>
                                        <p><strong>Gas Price:</strong> ${block.data.uploadInfo.transaction.gasPrice}</p>
                                        <p><strong>Status:</strong> ${block.data.uploadInfo.transaction.status}</p>
                                    ` : ''}
                                </div>
                            ` : ''}
                        `;
                    }
                    blockchainContainer.appendChild(blockElement);
                });
                document.getElementById('blockchainSection').style.display = 'block';
            } catch (error) {
                handleError(error, 'fetching blockchain data');
                const blockchainContainer = document.getElementById('blockchainContainer');
                blockchainContainer.innerHTML = `
                    <div class="error fade-in">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>Failed to load blockchain data. Please try again later.</span>
                    </div>
                `;
            }
        }

        async function updateSystemStatus() {
            try {
                const response = await fetch(`${API_URL}/status`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                await handleApiError(response);
                const data = await response.json();
                
                const pinataStatus = document.getElementById('pinataStatus');

                if (data.success) {
                    pinataStatus.textContent = 'Connected';
                    pinataStatus.className = 'connected';
                } else {
                    pinataStatus.textContent = 'Disconnected';
                    pinataStatus.className = 'disconnected';
                }
            } catch (error) {
                document.getElementById('pinataStatus').textContent = 'Error';
                document.getElementById('pinataStatus').className = 'disconnected';
                console.error('Status update failed:', error);
            }
        }

        updateSystemStatus();

        // Update the file details display function
        function updateFileDetails(fileData) {
            document.getElementById('fileName').textContent = fileData.fileName;
            document.getElementById('fileType').textContent = fileData.fileType;
            document.getElementById('fileSize').textContent = formatFileSize(fileData.fileSize);
            document.getElementById('uploadTime').textContent = new Date(fileData.uploadTime).toLocaleString();
            document.getElementById('uploadedBy').textContent = fileData.uploadedBy;
            
            document.getElementById('ipfsHash').textContent = fileData.ipfsHash;
            document.getElementById('pinataUrl').href = fileData.pinataUrl;
            document.getElementById('pinataUrl').textContent = 'View on IPFS';
            document.getElementById('blockHash').textContent = fileData.blockHash || 'Processing...';
            document.getElementById('previousHash').textContent = fileData.previousHash || 'Processing...';
            
            const tx = fileData.transaction;
            if (tx) {
                const txHashElement = document.getElementById('txHash');
                txHashElement.href = `https://sepolia.etherscan.io/tx/${tx.hash}`;
                txHashElement.textContent = tx.hash;
                document.getElementById('txFrom').textContent = tx.from;
                document.getElementById('txTo').textContent = tx.to;
                document.getElementById('txValue').textContent = tx.value;
                document.getElementById('txGasPrice').textContent = tx.gasPrice;
                document.getElementById('txStatus').textContent = tx.status;
                
                // Add status color
                const statusElement = document.getElementById('txStatus');
                statusElement.className = `status-${tx.status.toLowerCase()}`;
            }
            
            document.getElementById('fileDetails').style.display = 'block';
        }

        async function addQryptumNetwork() {
            try {
                await ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: '0x539', // Hex value of 1337
                        chainName: 'Qryptum Local Network',
                        nativeCurrency: {
                            name: 'QRYPT',
                            symbol: 'QRYPT',
                            decimals: 18
                        },
                        rpcUrls: ['http://127.0.0.1:8545'],
                        blockExplorerUrls: ['http://localhost:8545']
                    }]
                });
                console.log('Qryptum network added successfully');
            } catch (error) {
                console.error('Failed to add Qryptum network:', error);
                throw error;
            }
        }

        // Add this to your login success handler
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof ethereum !== 'undefined') {
                addQryptumNetwork().catch(console.error);
            }
        });

        // Update chain verification in your upload handler
        async function verifyChain() {
            if (typeof ethereum === 'undefined') {
                throw new Error('Please install MetaMask');
            }
            
            const chainId = await ethereum.request({ method: 'eth_chainId' });
            if (chainId !== '0x539') { // Check for hex 1337
                try {
                    await ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x539' }]
                    });
                } catch (error) {
                    if (error.code === 4902) {
                        await addQryptumNetwork();
                    } else {
                        throw error;
                    }
                }
            }
        }

        // Update your upload form event listener
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await verifyChain();
                // ...rest of your upload code...
            } catch (error) {
                console.error('Chain verification failed:', error);
                showNotification(error.message, 'error');
            }
        });

        // Replace the Web3 initialization code with this updated version
        let web3;
        let tokenContract;

        // Initialize Web3 and contract
        async function initWeb3() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    // Request account access
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    
                    // Initialize Web3
                    web3 = new Web3(window.ethereum);
                    console.log('Web3 initialized');
                    
                    // Initialize contract
                    tokenContract = new web3.eth.Contract(
                        QryptTokenABI,
                        QRYPTUM_CONFIG.TOKEN_ADDRESS
                    );
                    console.log('Contract initialized');
                    
                    return true;
                } catch (error) {
                    console.error('User denied account access or error occurred:', error);
                    throw error;
                }
            } else {
                throw new Error('Please install MetaMask!');
            }
        }

        // Update the upload form handler
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                // Initialize Web3 if not already initialized
                if (!web3) {
                    await initWeb3();
                }
                
                // Ensure connected to Qryptum network
                await verifyChain();

                const file = fileInput.files[0];
                const fileSizeInKB = file.size / 1024;
                
                // Convert to smallest unit (wei) first to avoid floating point issues
                const baseCharge = Math.floor(fileSizeInKB * 0.8 * 1e18); // 0.03% per 100KB, converted to wei
                const uploadChargeWei = baseCharge.toString();

                // Get accounts
                const accounts = await web3.eth.getAccounts();
                if (!accounts[0]) {
                    throw new Error('No account selected in MetaMask');
                }

                try {
                    showNotification('Requesting token approval...', 'info');
                    
                    // Approve token spending with proper Wei value
                    const approveResult = await tokenContract.methods.approve(
                        QRYPTUM_CONFIG.MAIN_ACCOUNT.ADDRESS,
                        uploadChargeWei
                    ).send({ 
                        from: accounts[0],
                        gas: '60000'  // Fixed gas value instead of hex
                    });

                    if (approveResult.status) {
                        console.log('Token approval successful');
                        showNotification('Token approval successful', 'success');

                        // Now proceed with the file upload
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('ethAddress', accounts[0]);
                        formData.append('approvalTx', approveResult.transactionHash);

                        // Continue with upload...
                        const uploadResponse = await fetch(`${API_URL}/upload`, {
                            method: 'POST',
                            headers: {
                                'X-User-Name': localStorage.getItem('username')
                            },
                            body: formData
                        });

                        if (!uploadResponse.ok) {
                            throw new Error('Upload failed after approval');
                        }

                        const uploadResult = await uploadResponse.json();
                        if (uploadResult.success) {
                            showNotification('File uploaded successfully!', 'success');
                            // Update UI and show celebration
                            const ethValue = web3.utils.fromWei(uploadChargeWei, 'ether');
                            showCelebration(ethValue, approveResult.transactionHash);
                        }
                    } else {
                        throw new Error('Token approval failed');
                    }
                } catch (approveError) {
                    console.error('Token approval failed:', approveError);
                    throw new Error('Token approval failed: ' + (approveError.message || 'Unknown error'));
                }
            } catch (error) {
                handleError(error);
            }
        });

        // Also update the file input change handler to match the decimal precision
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const fileSizeInKB = file.size / 1024;
                const baseCharge = Math.floor(fileSizeInKB * 0.8 * 1e18); // Same calculation as above
                const uploadChargeEth = web3.utils.fromWei(baseCharge.toString(), 'ether');
                const estimatedRewardEth = (parseFloat(uploadChargeEth) * 1.5).toFixed(18); // 50% more as reward
                
                fileUpload.querySelector('p').textContent = 
                    `Selected file: ${file.name} (${(fileSizeInKB / 1024).toFixed(2)} MB)
                    Upload charge: ${uploadChargeEth} ETH
                    Estimated reward: ${estimatedRewardEth} ETH`;
            }
        });

        // Initialize Web3 on page load
        document.addEventListener('DOMContentLoaded', () => {
            initWeb3().catch(console.error);
        });

        // Update the approveTokens function
        async function approveTokens(amount) {
            try {
                // Convert amount to wei (18 decimals)
                const amountInWei = ethers.utils.parseUnits(amount.toFixed(18), 'ether');
                
                const tx = await qryptToken.approve(contractAddress, amountInWei);
                await tx.wait();
                console.log('Token approval successful');
                return true;
            } catch (error) {
                console.error('Error approving tokens:', error);
                throw error;
            }
        }

        // Add debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Update form submission
        document.getElementById('uploadForm').addEventListener('submit', debounce(async (e) => {
            e.preventDefault();
            // ... rest of your upload logic ...
        }, 1000)); // 1 second debounce

        // Update the upload form handler to include transaction request
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                // Ensure connected to Qryptum network
                await verifyChain();

                const file = fileInput.files[0];
                const fileSizeInKB = file.size / 1024;
                
                // Convert to smallest unit (wei) first to avoid floating point issues
                const baseCharge = Math.floor(fileSizeInKB * 0.8 * 1e18); // 0.03% per 100KB, converted to wei
                const uploadChargeWei = baseCharge.toString();

                // Get accounts
                const accounts = await web3.eth.getAccounts();
                if (!accounts[0]) {
                    throw new Error('No account selected in MetaMask');
                }

                // Request transaction approval via MetaMask
                const transactionParameters = {
                    to: RECEIVER_ADDRESS,
                    from: accounts[0],
                    value: web3.utils.toHex(uploadChargeWei),
                    gas: web3.utils.toHex(21000),
                    gasPrice: web3.utils.toHex(await web3.eth.getGasPrice())
                };

                const txHash = await ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [transactionParameters],
                });

                showNotification('Transaction sent, waiting for confirmation...', 'info');

                // Wait for transaction confirmation
                const receipt = await waitForTransaction(web3, txHash);
                
                if (!receipt.status) {
                    throw new Error('Transaction failed');
                }

                showNotification('Payment confirmed! Uploading file...', 'success');

                // Now proceed with file upload
                const formData = new FormData();
                formData.append('file', file);
                formData.append('ethAddress', accounts[0]);
                formData.append('transactionHash', txHash);

                const uploadResponse = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    headers: {
                        'X-User-Name': localStorage.getItem('username')
                    },
                    body: formData
                });

                if (!uploadResponse.ok) {
                    const errorData = await uploadResponse.json();
                    throw new Error(errorData.message || 'Upload failed');
                }

                const uploadResult = await uploadResponse.json();
                
                if (uploadResult.success) {
                    showNotification('File uploaded successfully!', 'success');
                    // Update UI and show celebration
                    const ethValue = web3.utils.fromWei(uploadChargeWei, 'ether');
                    showCelebration(ethValue, txHash);
                }
            } catch (error) {
                handleError(error);
            }
        });

    </script>
</body>
</html>